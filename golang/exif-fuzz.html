<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Exif Parser Fuzzing - Jan0ski's Security Blog</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../prefix.html">Index</a></li><li class="chapter-item expanded affix "><li class="part-title">Offensive Go</li><li class="chapter-item expanded "><a href="../golang/rev-shell.html"><strong aria-hidden="true">1.</strong> Reverse Shell</a></li><li class="chapter-item expanded "><a href="../golang/code-injection.html"><strong aria-hidden="true">2.</strong> Code Injection</a></li><li class="chapter-item expanded "><a href="../golang/exif-fuzz.html" class="active"><strong aria-hidden="true">3.</strong> Exif Parser Fuzzing</a></li><li class="chapter-item expanded affix "><li class="part-title">Cloud Security</li><li class="chapter-item expanded affix "><li class="part-title">CTF Write-ups</li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Jan0ski's Security Blog</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#exif-parser-fuzzing" id="exif-parser-fuzzing">Exif Parser Fuzzing</a></h1>
<p>Writing a custom fuzzer for an exif parser using Go.</p>
<hr />
<h2><a class="header" href="#easy-fuzzing-target" id="easy-fuzzing-target">Easy Fuzzing Target</a></h2>
<p>A light google search of common fuzzing targets implemented in memory-unsafe languages such as C leads me to find <a href="https://github.com/mkttanabe/exif/">this</a> repo. It's a great, simple implementation of an exif parser and will work perfectly for our purposes.</p>
<p>To test the output of the tool, compile the binary and run it on a sample jpg containing exif data. A great sample set can be found at https://github.com/ianare/exif-samples.</p>
<pre><code>~/exifFuzz/exif $ make
~/exifFuzz/exif $ ./exif ../exif-samples/Canon_40D.jpg

[Canon_40D.jpg] createIfdTableArray: result=4

{0TH IFD}
 - Make: [Apple]
 - Model: [iPod touch]
 - Orientation: 1
... snip ...
</code></pre>
<hr />
<h2><a class="header" href="#designing-the-fuzzer" id="designing-the-fuzzer">Designing the Fuzzer</a></h2>
<p>Fuzzing in general is all about rapidly varying the inputs of an application. In this case, all the data we have to manipulate is the contents of our input file. Randomly chaning individual bytes or patterns in the input file is bound to produce some unexpected results. This means our fuzzer will need to perform the following actions:</p>
<ul>
<li>Read in the bytes of a file.</li>
<li>Manipulate the bytes of a file in various ways.</li>
<li>Save the new mutated file.</li>
<li>Run the exif binary on the mutated file.</li>
<li>Detect interesting crashes of the program.</li>
<li>Save the output of these crashes to a file with a meaningful name.</li>
<li>Repeat many many times.</li>
</ul>
<hr />
<h2><a class="header" href="#file-operations" id="file-operations">File Operations</a></h2>
<p>To manipulate the bytes of an input file, we use the <code>ioutil</code> package. We'll create two functions, <code>getBytes</code> and <code>createNew</code> that we will use to read the input file into a slice of bytes and then create a new file after we've mutated them. We can also include a small function, check that we use to check error values.</p>
<p>These helper functions are done simply:</p>
<pre><code class="language-go">// Check and panic on error
func check(e error) {
    if e != nil {
    panic(e)
    }
}

// Retrieve bytes from `filename`
func getBytes(filename string) []byte {
    f, err := ioutil.ReadFile(filename)
    check(err)
    return f
}

// Create new file with `data`
func createNew(data []byte) {
    err := ioutil.WriteFile(&quot;mutated.jpg&quot;, data, 0644)
    check(err)
}
</code></pre>
<hr />
<h2><a class="header" href="#input-file-mutation" id="input-file-mutation">Input File Mutation</a></h2>
<p>###The Bit Flip
An easy way to change input data is a simple bit flip. To implement this, I decided I would randomly select a percentage of the bytes in the file, and of that subset I'd change a byte randomly. This is slightly different than changing a singular bit randomly throughout the file, however I felt it achieved generally the same effect.</p>
<p>To begin we'll need to select bytes at random, keeping track of their indexes in the input byte slice. We subtract 4 bytes off of the the file length to account for the <code>FF D8 FF DB</code> jpg file header.</p>
<pre><code class="language-go">var byteIndexes []int
numBytes := int(float64(len(data)-4) * .01)
for len(byteIndexes) &lt; numBytes {
    // For random ints in range = rand.Intn(Max - Min) + Min
    byteIndexes = append(byteIndexes, rand.Intn((len(data)-4)-4)+4)
}
fmt.Println(&quot;Indexes chosen: &quot;, byteIndexes)
</code></pre>
<p>Knowing these indexes, we'll then loop through the data and change the values of the target bytes, and return the mutated byte slice.</p>
<pre><code class="language-go">// Randomly change the bytes at the location of the chosen indexes
    for _, index := range byteIndexes {
        oldbytes := data[index]
        newbytes := byte(rand.Intn(0xFF))
        data[index] = newbytes
        fmt.Printf(&quot;Changed %x to %x\n&quot;, oldbytes, newbytes)
    }
    return data
</code></pre>
<hr />
<h3><a class="header" href="#getting-more-sophisticated---magic-numbers" id="getting-more-sophisticated---magic-numbers">Getting More Sophisticated - Magic Numbers</a></h3>
<p>Since I generally don't know what I'm doing, I tend to read many blogs and watch technology streams to discover techniques in areas that I'm unfamiliar with - like Fuzzing! <a href="https://twitter.com/gynvael">Gynvael's YouTube channel</a> has loads of resources on fuzzing and is a great resource for learning more. In his intro to fuzzing stream, he mentions &quot;Magic Numbers&quot; in files that are ripe for manipulation.</p>
<p>The numbers are chosen based on the propensity for errors like integer underflow or overflow to result from changing their values.</p>
<ul>
<li><code>0xFF</code></li>
<li><code>0x7F</code></li>
<li><code>0x00</code></li>
<li><code>0xFFFF</code></li>
<li><code>0x0000</code></li>
<li><code>0xFFFFFFFF</code></li>
<li><code>0x00000000</code></li>
<li><code>0x80000000</code> (Minimum 32-bit integer)</li>
<li><code>0x40000000</code> (1/2 Min 32-bit integer)</li>
<li><code>0x7FFFFFFF</code> (Maximum 32-bit integer)</li>
</ul>
<p>For example, if <code>0x7FFFFFFF</code> is chosen as the value to replace, we'll have to replace the first byte with <code>0x7F</code> and then each subsequent byte with <code>0xFF</code> for a total of 4 bytes in length.</p>
<p>We'll construct a mapping for these values in a slice of int slices, and then pick a set at random to tell us what to change in the input data.</p>
<pre><code class="language-go">// Gynvael's magic numbers https://www.youtube.com/watch?v=BrDujogxYSk&amp;
magicVals := [][]int{
    {1, 255},
    {1, 255},
    {1, 127},
    {1, 0},
    {2, 255},
    {2, 0},
    {4, 255},
    {4, 0},
    {4, 128},
    {4, 64},
    {4, 127},
}

pickedMagic := magicVals[rand.Intn(len(magicVals))]
index := rand.Intn(len(data) - 8)
</code></pre>
<hr />

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../golang/code-injection.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../golang/code-injection.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
